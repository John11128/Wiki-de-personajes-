<!DOCTYPE html>

<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Wiki de Personajes</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f0f0;
      margin: 0;
      padding: 1em;
    }
    nav button {
      margin: 5px;
      padding: 10px 15px;
      font-size: 14px;
    }
    section {
      display: none;
      margin-top: 1em;
    }
    section.active {
      display: block;
    }
    .personaje {
      background: white;
      border: 1px solid #ccc;
      padding: 1em;
      margin-bottom: 1em;
      border-radius: 8px;
    }
    .personaje img {
      max-width: 150px;
      display: block;
      margin-top: 5px;
    }
    input, textarea, select {
      display: block;
      margin: 5px 0;
      width: 100%;
      max-width: 400px;
      padding: 6px;
    }
    .crud-buttons {
      margin-top: 10px;
    }
    .crud-buttons button {
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <h1>Wiki de Personajes</h1>
  <nav>
    <button onclick="mostrarSeccion('ver')">Ver personajes</button>
    <button onclick="mostrarSeccion('agregar')">Agregar personaje</button>
    <button onclick="mostrarSeccion('editar')">Editar/Borrar personajes</button>
  </nav>

  <section id="ver">
    <h2>Lista de personajes</h2>
    <div id="lista"></div>
  </section>

  <section id="agregar">
    <h2>Agregar nuevo personaje</h2>
    <form onsubmit="agregarPersonaje(event)">
      <input type="text" id="nombre" placeholder="Nombre" required>
      <textarea id="descripcion" placeholder="Descripción" required></textarea>
      <input type="url" id="imagen_url" placeholder="URL de imagen" required>

```
  <label>Facción:</label>
  <select id="faccion" required>
    <option value="Fujimafia">Fujimafia</option>
    <option value="Ruinas de los Caballeros">Ruinas de los Caballeros</option>
    <option value="Coalición Oculta">Coalición Oculta</option>
    <option value="Horda Ardiente">Horda Ardiente</option>
    <option value="Academia de Luz">Academia de Luz</option>
    <option value="Clanes del Norte">Clanes del Norte</option>
  </select>

  <label>Rol:</label>
  <select id="rol" required>
    <option value="Héroe">Héroe</option>
    <option value="Villano">Villano</option>
    <option value="Ente del Caos">Ente del Caos</option>
    <option value="Neutral">Neutral</option>
  </select>

  <button type="submit">Agregar</button>
</form>
```

  </section>

  <section id="editar">
    <h2>Editar/Borrar personajes</h2>
    <div id="listaCRUD"></div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <script>
    const supabase = supabase.createClient('https://yfusfwzvnwnjdqbsmboh.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlmdXNmd3p2bnduamRxYnNtYm9oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MTQwOTIsImV4cCI6MjA2MTk5MDA5Mn0.4OuM1Z3-6MKdJsJPTSNPpBO2FNobmIFF44J7mQuCNms');

    function mostrarSeccion(id) {
      document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      if (id === 'ver') mostrarPersonajes();
      if (id === 'editar') mostrarCRUD();
    }

    async function mostrarPersonajes() {
      const { data: personajes, error } = await supabase
        .from('personajes')
        .select('*');

      const contenedor = document.getElementById('lista');
      contenedor.innerHTML = '';

      personajes.forEach(p => {
        contenedor.innerHTML += `
          <div class="personaje">
            <h3>${p.nombre}</h3>
            <p>${p.descripcion}</p>
            <img src="${p.imagen_url}" alt="${p.nombre}">
            <p><strong>Facción:</strong> ${p.faccion}</p>
            <p><strong>Rol:</strong> ${p.rol}</p>
          </div>
        `;
      });
    }

    async function agregarPersonaje(e) {
      e.preventDefault();
      const nombre = document.getElementById('nombre').value;
      const descripcion = document.getElementById('descripcion').value;
      const imagen_url = document.getElementById('imagen_url').value;
      const faccion = document.getElementById('faccion').value;
      const rol = document.getElementById('rol').value;

      const { error } = await supabase
        .from('personajes')
        .insert([{ nombre, descripcion, imagen_url, faccion, rol }]);

      if (error) {
        alert('Error al agregar personaje.');
        console.error(error);
      } else {
        alert('Personaje agregado.');
        e.target.reset();
        mostrarSeccion('ver');
      }
    }

    async function mostrarCRUD() {
      const { data: personajes, error } = await supabase
        .from('personajes')
        .select('*');

      const contenedor = document.getElementById('listaCRUD');
      contenedor.innerHTML = '';

      personajes.forEach(p => {
        contenedor.innerHTML += `
          <div class="personaje">
            <input type="text" id="edit-nombre-${p.id}" value="${p.nombre}">
            <textarea id="edit-desc-${p.id}">${p.descripcion}</textarea>

```
        <input type="url" id="edit-imagen-${p.id}" value="${p.imagen_url}">

        <label>Facción:</label>
        <select id="edit-faccion-${p.id}">
          <option value="Fujimafia" ${p.faccion === "Fujimafia" ? "selected" : ""}>Fujimafia</option>
          <option value="Ruinas de los Caballeros" ${p.faccion === "Ruinas de los Caballeros" ? "selected" : ""}>Ruinas de los Caballeros</option>
          <option value="Coalición Oculta" ${p.faccion === "Coalición Oculta" ? "selected" : ""}>Coalición Oculta</option>
          <option value="Horda Ardiente" ${p.faccion === "Horda Ardiente" ? "selected" : ""}>Horda Ardiente</option>
          <option value="Academia de Luz" ${p.faccion === "Academia de Luz" ? "selected" : ""}>Academia de Luz</option>
          <option value="Clanes del Norte" ${p.faccion === "Clanes del Norte" ? "selected" : ""}>Clanes del Norte</option>
        </select>

        <label>Rol:</label>
        <select id="edit-rol-${p.id}">
          <option value="Héroe" ${p.rol === "Héroe" ? "selected" : ""}>Héroe</option>
          <option value="Villano" ${p.rol === "Villano" ? "selected" : ""}>Villano</option>
          <option value="Ente del Caos" ${p.rol === "Ente del Caos" ? "selected" : ""}>Ente del Caos</option>
          <option value="Neutral" ${p.rol === "Neutral" ? "selected" : ""}>Neutral</option>
        </select>

        <div class="crud-buttons">
          <button onclick="actualizarPersonaje(${p.id})">Actualizar</button>
          <button onclick="eliminarPersonaje(${p.id})">Eliminar</button>
        </div>
      </div>
    `;
  });
}

async function actualizarPersonaje(id) {
  const nombre = document.getElementById(`edit-nombre-${id}`).value;
  const descripcion = document.getElementById(`edit-desc-${id}`).value;
  const imagen_url = document.getElementById(`edit-imagen-${id}`).value;
  const faccion = document.getElementById(`edit-faccion-${id}`).value;
  const rol = document.getElementById(`edit-rol-${id}`).value;

  const { error } = await supabase
    .from('personajes')
    .update({ nombre, descripcion, imagen_url, faccion, rol })
    .eq('id', id);

  if (error) {
    alert("Error al actualizar personaje.");
    console.error(error);
  } else {
    alert("Personaje actualizado.");
    mostrarCRUD();
  }
}

async function eliminarPersonaje(id) {
  if (!confirm("¿Seguro que querés eliminar este personaje?")) return;

  const { error } = await supabase
    .from('personajes')
    .delete()
    .eq('id', id);

  if (error) {
    alert("Error al eliminar personaje.");
    console.error(error);
  } else {
    alert("Personaje eliminado.");
    mostrarCRUD();
  }
}
    async function actualizarPersonaje(id) {
      const nombre = document.getElementById(`edit-nombre-${id}`).value;
      const descripcion = document.getElementById(`edit-desc-${id}`).value;
      const imagen_url = document.getElementById(`edit-imagen-${id}`).value;
      const faccion = document.getElementById(`edit-faccion-${id}`).value;
      const rol = document.getElementById(`edit-rol-${id}`).value;

      const { error } = await supabase
        .from('personajes')
        .update({ nombre, descripcion, imagen_url, faccion, rol })
        .eq('id', id);

      if (error) {
        alert('Error al actualizar el personaje.');
        console.error(error);
      } else {
        alert('Personaje actualizado.');
        mostrarCRUD();
      }
    }

    async function eliminarPersonaje(id) {
      if (!confirm('¿Estás seguro de que quieres eliminar este personaje?')) return;

      const { error } = await supabase
        .from('personajes')
        .delete()
        .eq('id', id);

      if (error) {
        alert('Error al eliminar el personaje.');
        console.error(error);
      } else {
        alert('Personaje eliminado.');
        mostrarCRUD();
      }
    }

    // Mostrar sección por defecto
    mostrarSeccion('ver');
  </script>
</body>
</html>


  </script>
</body>
</html>                         // Configuración de Supabase (asegúrate de tener estas variables definidas)
const supabaseUrl = 'https://yfusfwzvnwnjdqbsmboh.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlmdXNmd3p2bnduamRxYnNtYm9oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MTQwOTIsImV4cCI6MjA2MTk5MDA5Mn0.4OuM1Z3-6MKdJsJPTSNPpBO2FNobmIFF44J7mQuCNms';
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

// Función principal para agregar personajes
async function agregarPersonaje() {
// Obtener elementos del DOM
const botonGuardar = document.querySelector('#agregar button');
const nombreInput = document.getElementById('nombre');
const descripcionInput = document.getElementById('descripcion');
const imagenInput = document.getElementById('imagen');

// Obtener y limpiar valores
const nombre = nombreInput.value.trim();
const descripcion = descripcionInput.value.trim();
const imagen = imagenInput.value.trim();
const faccion = document.getElementById('faccion').value;
const rol = document.getElementById('rol').value;

// Validación de campos
if (!validarCampos(nombre, descripcion, imagen, nombreInput, descripcionInput, imagenInput)) {
return;
}

// Configurar estado de carga
botonGuardar.disabled = true;
botonGuardar.innerHTML = '<span class="spinner-mini"></span> Guardando...';

try {
// Intentar conexión con Supabase
const { data, error } = await supabase
.from('personajes')
.insert(\[{
nombre,
descripcion,
imagen\_url: imagen,
faccion,
rol
}])
.select();

```
// Manejar respuesta
manejarRespuesta(data, error, nombreInput, descripcionInput, imagenInput);
```

} catch (error) {
manejarError(error);
} finally {
// Restaurar botón
botonGuardar.disabled = false;
botonGuardar.innerHTML = 'Guardar';
}
}

// Función de validación de campos
function validarCampos(nombre, descripcion, imagen, nombreInput, descripcionInput, imagenInput) {
let isValid = true;

if (!nombre) {
mostrarError("El nombre es obligatorio", nombreInput);
isValid = false;
} else if (nombre.length > 50) {
mostrarError("El nombre no puede exceder 50 caracteres", nombreInput);
isValid = false;
}

if (!descripcion) {
mostrarError("La descripción es obligatoria", descripcionInput);
isValid = false;
} else if (descripcion.length > 500) {
mostrarError("La descripción no puede exceder 500 caracteres", descripcionInput);
isValid = false;
}

if (!imagen) {
mostrarError("La URL de la imagen es obligatoria", imagenInput);
isValid = false;
} else if (!validarURL(imagen)) {
mostrarError("Ingrese una URL de imagen válida (jpg, png, gif, webp)", imagenInput);
isValid = false;
}

return isValid;
}

// Función para manejar la respuesta de Supabase
function manejarRespuesta(data, error, nombreInput, descripcionInput, imagenInput) {
if (error) {
// Error específico de Supabase
if (error.code === 'PGRST301' || error.message.includes('relation "personajes" does not exist')) {
throw new Error("La tabla 'personajes' no existe en la base de datos");
} else if (error.message.includes('JWT expired')) {
throw new Error("Conexión expirada. Recargue la página.");
} else {
throw error;
}
}

if (!data || data.length === 0) {
throw new Error("No se recibió confirmación de la base de datos");
}

// Éxito - limpiar formulario
nombreInput.value = '';
descripcionInput.value = '';
imagenInput.value = '';
document.getElementById('faccion').selectedIndex = 0;
document.getElementById('rol').selectedIndex = 0;

mostrarExito(`Personaje "${data[0].nombre}" guardado correctamente`);
}

// Función para manejar errores
function manejarError(error) {
console.error("Error completo:", error);

let mensajeError = "Error al guardar el personaje";

if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
mensajeError = "Error de conexión. Verifique su internet o si el servidor está disponible";
} else if (error.message) {
mensajeError += ": " + error.message;
}

mostrarError(mensajeError);
}

// Función para validar URLs de imagen
function validarURL(url) {
try {
new URL(url); // Verifica que sea una URL válida
const extensionesValidas = \['.jpg', '.jpeg', '.png', '.gif', '.webp'];
return extensionesValidas.some(ext => url.toLowerCase().includes(ext));
} catch {
return false;
}
}

// Función para mostrar errores
function mostrarError(mensaje, elementoInput = null) {
// Eliminar mensajes anteriores
const erroresAnteriores = document.querySelectorAll('.mensaje-error');
erroresAnteriores.forEach(el => el.remove());

// Crear elemento de error
const errorDiv = document.createElement('div');
errorDiv.className = 'mensaje-error';
errorDiv.innerHTML = `⛔ ${mensaje}`;

// Insertar en el formulario
const formulario = document.getElementById('agregar');
formulario.insertBefore(errorDiv, formulario.firstChild);

// Enfocar el campo con error
if (elementoInput) {
elementoInput.focus();
elementoInput.classList.add('input-error');
setTimeout(() => elementoInput.classList.remove('input-error'), 2000);
}

// Auto-eliminación después de 5 segundos
setTimeout(() => errorDiv.remove(), 5000);
}

// Función para mostrar éxito
function mostrarExito(mensaje) {
const exitoDiv = document.createElement('div');
exitoDiv.className = 'mensaje-exito';
exitoDiv.innerHTML = `✅ ${mensaje}`;

const agregarSection = document.getElementById('agregar');
const existingExito = agregarSection.querySelector('.mensaje-exito');
if (existingExito) existingExito.remove();

agregarSection.insertBefore(exitoDiv, agregarSection.firstChild);
setTimeout(() => exitoDiv.remove(), 5000);
}

// Función para mostrar personajes con manejo de carga
async function mostrarPersonajes() {
mostrarCarga();
try {
const { data: personajes, error } = await supabase.from('personajes').select('\*');
if (error) throw error;

```
const contenedor = document.getElementById('listaPersonajes');
contenedor.innerHTML = '';

if (personajes.length === 0) {
  contenedor.innerHTML = '<p>No hay personajes registrados todavía.</p>';
  return;
}

personajes.forEach(p => {
  contenedor.innerHTML += `
    <div class="personaje">
      ${p.imagen_url ? `<img src="${p.imagen_url}" alt="Imagen de ${p.nombre}">` : ''}
      <h3>${p.nombre}</h3>
      <p>${p.descripcion}</p>
      <p><strong>Facción:</strong> ${p.faccion}</p>
      <p><strong>Rol:</strong> ${p.rol}</p>
    </div>
  `;
});
```

} catch (error) {
console.error('Error al obtener los personajes:', error);
mostrarError("Error al cargar los personajes");
} finally {
ocultarCarga();
}
}

// Funciones para el loader
function mostrarCarga() {
const loadingDiv = document.createElement('div');
loadingDiv.className = 'loading';
loadingDiv.innerHTML = '<div class="spinner"></div>';
document.body.appendChild(loadingDiv);
}

function ocultarCarga() {
const loadingDiv = document.querySelector('.loading');
if (loadingDiv) loadingDiv.remove();
}
